services:
  postgres:
    image: postgres:15-alpine
    container_name: ibsys_postgres
    environment:
      POSTGRES_USER: sensor
      POSTGRES_PASSWORD: sensorpw
      POSTGRES_DB: sensor_db
    # Host port changed to 5433 to avoid collision with an existing local Postgres
    ports:
      - '5433:5432'
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sensor -d sensor_db"]
      interval: 5s
      timeout: 3s
      retries: 5
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./provisioning/init.sql:/docker-entrypoint-initdb.d/init.sql:ro

  grafana:
    image: grafana/grafana-oss:10.2.2
    container_name: ibsys_grafana
    depends_on:
      - postgres
    ports:
      - '3000:3000'
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_SECURITY_ADMIN_USER: admin
      GF_LOG_LEVEL: warn
    volumes:
      - ./provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./provisioning/alerting:/etc/grafana/provisioning/alerting:ro

  worker:
    build: ./worker
    container_name: ibsys_worker
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://sensor:sensorpw@postgres:5432/sensor_db
      ALERT_DURATION_SECONDS: '20'
      WORKER_CHECK_INTERVAL: '2'
    ports:
      - '5001:5000'

  sensor:
    build: ./sensor
    container_name: ibsys_sensor
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://sensor:sensorpw@postgres:5432/sensor_db
      WRITE_INTERVAL_SECONDS: '5'
      SENSOR_NAME: lackieranlage_1
      PARAMETER: kabinentemperatur
      UNIT: 'Â°C'
      MIN_VALUE: '18'
      MAX_VALUE: '30'
      THRESHOLD_HIGH: '28'
      THRESHOLD_LOW: '18'
      ANOMALY_CYCLE_MINUTES: '0.5'
      ANOMALY_DURATION_SECONDS: '180'  # 3 minutes for full alert cycle
      BUILDUP_SECONDS: '10'
      RECOVERY_SECONDS: '15'
    restart: unless-stopped

  sensor_humidity:
    build: ./sensor
    container_name: ibsys_sensor_humidity
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://sensor:sensorpw@postgres:5432/sensor_db
      WRITE_INTERVAL_SECONDS: '6'
      SENSOR_NAME: lackieranlage_1
      PARAMETER: luftfeuchtigkeit
      UNIT: '%'
      MIN_VALUE: '25'
      MAX_VALUE: '70'
      THRESHOLD_HIGH: '65'
      THRESHOLD_LOW: '30'
      ANOMALY_CYCLE_MINUTES: '0.7'
      ANOMALY_DURATION_SECONDS: '180'  # 3 minutes
      BUILDUP_SECONDS: '12'
      RECOVERY_SECONDS: '18'
    restart: unless-stopped

  sensor_spray:
    build: ./sensor
    container_name: ibsys_sensor_spray
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://sensor:sensorpw@postgres:5432/sensor_db
      WRITE_INTERVAL_SECONDS: '4'
      SENSOR_NAME: lackieranlage_1
      PARAMETER: duesendruck
      UNIT: 'bar'
      MIN_VALUE: '1.5'
      MAX_VALUE: '3.5'
      THRESHOLD_HIGH: '3.2'
      THRESHOLD_LOW: '1.8'
      ANOMALY_CYCLE_MINUTES: '0.8'
      ANOMALY_DURATION_SECONDS: '180'  # 3 minutes
      BUILDUP_SECONDS: '12'
      RECOVERY_SECONDS: '15'
    restart: unless-stopped

  sensor_energy:
    build: ./sensor
    container_name: ibsys_sensor_energy
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://sensor:sensorpw@postgres:5432/sensor_db
      WRITE_INTERVAL_SECONDS: '8'
      SENSOR_NAME: lackieranlage_1
      PARAMETER: energieverbrauch
      UNIT: 'kW'
      MIN_VALUE: '15'
      MAX_VALUE: '25'
      THRESHOLD_HIGH: '28'
      THRESHOLD_LOW: '12'
      ANOMALY_CYCLE_MINUTES: '0.6'
      ANOMALY_DURATION_SECONDS: '180'  # 3 minutes
      BUILDUP_SECONDS: '12'
      RECOVERY_SECONDS: '18'
    restart: unless-stopped

  cleanup:
    image: postgres:15-alpine
    container_name: ibsys_cleanup
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGHOST: postgres
      PGPORT: 5432
      PGUSER: sensor
      PGPASSWORD: sensorpw
      PGDATABASE: sensor_db
    volumes:
      - ./provisioning/cleanup.sql:/cleanup.sql:ro
    command: >
      sh -c "
      while true; do
        echo '[CLEANUP] Running database cleanup at $(date)';
        psql -f /cleanup.sql;
        echo '[CLEANUP] Next cleanup in 24 hours';
        sleep 86400;
      done
      "
    restart: unless-stopped

  alert_setup:
    build: ./setup
    container_name: ibsys_alert_setup
    depends_on:
      - grafana
    environment:
      GRAFANA_URL: http://grafana:3000
    restart: "no"

volumes:
  pgdata:
